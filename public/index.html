<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniVoice v13 ‚Äì Enterprise Feedback System</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .version-badge {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      color: #667eea;
      z-index: 999;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .login-page {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: white;
      padding: 50px 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 420px;
      width: 100%;
    }

    .login-logo {
      text-align: center;
      margin-bottom: 40px;
    }

    .login-logo h1 {
      color: #667eea;
      font-size: 36px;
      margin-bottom: 8px;
    }

    .login-logo p {
      color: #718096;
      font-size: 14px;
    }

    .dashboard-page {
      display: none;
    }

    .dashboard-page.active {
      display: block;
    }

    .notification-banner {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
      padding: 12px 20px;
      text-align: center;
      font-size: 14px;
      display: none;
    }

    .notification-banner.show {
      display: block;
    }

    .notification-banner button {
      background: white;
      color: #f59e0b;
      padding: 6px 16px;
      margin-left: 12px;
      font-size: 13px;
    }

    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    header h2 {
      color: #667eea;
      font-size: 28px;
      font-weight: 700;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-email {
      color: #4a5568;
      font-size: 14px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 10px 24px;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
      font-size: 14px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .card {
      background: white;
      padding: 30px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .card h3 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 22px;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 12px 16px;
      margin-top: 8px;
      background: #f7fafc;
      color: #2d3748;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      color: #4a5568;
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
      margin: 8px 4px 8px 0;
    }

    .status-not-resolved {
      background: #fed7d7;
      color: #c53030;
    }

    .status-in-progress {
      background: #bee3f8;
      color: #2c5282;
    }

    .status-resolved {
      background: #c6f6d5;
      color: #22543d;
    }

    .sla-green {
      background: #c6f6d5;
      color: #22543d;
    }

    .sla-yellow {
      background: #fef5e7;
      color: #d68910;
    }

    .sla-red {
      background: #fed7d7;
      color: #c53030;
    }

    .anonymous-badge {
      background: #718096;
      color: white;
    }

    .category-academic {
      background: #fef5e7;
      color: #d68910;
    }

    .category-hostel {
      background: #e8daef;
      color: #7d3c98;
    }

    .category-faculty {
      background: #d5f4e6;
      color: #117a65;
    }

    .category-infrastructure {
      background: #d6eaf8;
      color: #1f618d;
    }

    .category-library {
      background: #fce4ec;
      color: #c2185b;
    }

    .category-canteen {
      background: #fff3e0;
      color: #ef6c00;
    }

    .category-transport {
      background: #e0f2f1;
      color: #00695c;
    }

    .category-sports {
      background: #f3e5f5;
      color: #6a1b9a;
    }

    .category-placement {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .category-safety {
      background: #ffebee;
      color: #c62828;
    }

    .category-other {
      background: #e5e7e9;
      color: #626567;
    }

    .hidden {
      display: none;
    }

    .feedback-item {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 16px;
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* Auth Split Layout */
    /* Auth Tabbed Layout */
    .login-container {
      background: rgba(30, 41, 59, 0.95);
      padding: 3rem;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      width: 100%;
      max-width: 440px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      margin: 20px;
    }

    .auth-tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 2rem;
    }

    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 12px;
      cursor: pointer;
      border-radius: 8px;
      color: #94a3b8;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }

    .auth-tab.active {
      background: #667eea;
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .auth-tab:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .forgot-password-link {
      color: #667eea;
      text-align: right;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      cursor: pointer;
      display: inline-block;
      transition: color 0.2s;
    }

    .forgot-password-link:hover {
      text-decoration: underline;
      color: #8b5cf6;
    }

    .forgot-password-link {
      color: var(--secondary-color);
      text-align: right;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      cursor: pointer;
      display: block;
    }

    .forgot-password-link:hover {
      text-decoration: underline;
    }

    .feedback-text {
      color: #2d3748;
      margin-bottom: 12px;
      line-height: 1.6;
    }

    .feedback-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 12px;
    }

    .upvote-btn {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      padding: 8px 16px;
      font-size: 13px;
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .stat-card.danger {
      background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
    }

    .stat-number {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }

    .chart-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 30px;
    }

    .filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-bar select {
      flex: 1;
      min-width: 150px;
      margin-top: 0;
    }

    .submit-btn {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      margin-top: 16px;
    }

    .comments-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }

    .comment {
      background: #f7fafc;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .comment-author {
      font-weight: 600;
      color: #667eea;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .comment-text {
      color: #4a5568;
      font-size: 14px;
      line-height: 1.5;
    }

    .comment-form {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .comment-input {
      flex: 1;
      padding: 8px 12px;
      margin-top: 0;
      font-size: 13px;
    }

    .comment-btn {
      padding: 8px 16px;
      font-size: 13px;
      white-space: nowrap;
    }

    .toggle-comments-btn {
      background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
      padding: 6px 12px;
      font-size: 12px;
      margin-left: 8px;
    }

    .search-bar {
      margin-bottom: 20px;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 40px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cpath d='m21 21-4.35-4.35'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 12px center;
      background-size: 18px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      margin-top: 12px;
    }

    .checkbox-label input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }

    .sla-timer {
      font-weight: 600;
      font-size: 13px;
    }

    .image-link {
      display: inline-block;
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border-radius: 8px;
      text-decoration: none;
      margin-top: 8px;
      font-size: 13px;
      transition: all 0.2s;
    }

    .image-link:hover {
      background: #764ba2;
      transform: translateY(-2px);
    }

    .reset-password-btn {
      background: transparent;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 10px 24px;
      margin-top: 16px;
      width: 100%;
    }

    .reset-password-btn:hover {
      background: #f7fafc;
    }

    .success-message {
      background: #c6f6d5;
      color: #22543d;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      text-align: center;
      font-size: 14px;
    }

    .error-message {
      background: #fed7d7;
      color: #c53030;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      text-align: center;
      font-size: 14px;
    }

    .info-text {
      color: #718096;
      font-size: 13px;
      margin-top: 8px;
      text-align: center;
    }

    @media (max-width: 768px) {
      .chart-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="version-badge">v13.0</div>

  <!-- AUTH PAGE -->
  <div id="loginPage" class="login-container-wrapper"
    style="display: flex; justify-content: center; align-items: center; min-height: 100vh; width: 100%;">

    <div class="login-container">

      <!-- Logo & Header -->
      <div style="text-align: center; margin-bottom: 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üéì</div>
        <h1 style="color: white; margin: 0; font-size: 1.8rem;">UniVoice</h1>
        <p style="color: #94a3b8; font-size: 0.95rem;">Enterprise Feedback System</p>
      </div>

      <!-- Tab Switcher -->
      <div class="auth-tabs">
        <div id="tab-login" class="auth-tab active" onclick="switchAuthMode('login')">Login</div>
        <div id="tab-signup" class="auth-tab" onclick="switchAuthMode('signup')">New Student</div>
      </div>

      <!-- LOGIN FORM -->
      <div id="loginForm">
        <div class="form-group">
          <label style="color: #e2e8f0;">Email</label>
          <input type="email" id="loginEmail" placeholder="your.name_cs23@gla.ac.in"
            style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;">
        </div>

        <div class="form-group">
          <label style="color: #e2e8f0;">Password</label>
          <input type="password" id="loginPassword" placeholder="Enter password"
            style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;">
          <div style="text-align: right;">
            <a onclick="forgotPassword()" class="forgot-password-link">Forgot Password?</a>
          </div>
        </div>

        <button onclick="handleLogin()" class="submit-btn"
          style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-top: 1rem;">Login</button>
      </div>

      <!-- SIGN UP FORM -->
      <div id="signupForm" style="display: none;">
        <div class="form-group">
          <label style="color: #e2e8f0;">College Email (@gla.ac.in)</label>
          <input type="email" id="signupEmail" placeholder="your.name_cs23@gla.ac.in"
            style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;">
        </div>

        <p class="info-text"
          style="color: #94a3b8; margin-bottom: 1.5rem; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: left; line-height: 1.5;">
          ‚ÑπÔ∏è Enter your college email. Check your inbox and spam folder for the setup link.
        </p>

        <button onclick="handleSignup()" class="submit-btn"
          style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); margin-top: 0.5rem;">
          Verify & Set Password
        </button>
      </div>

      <!-- MESSAGE AREA -->
      <div id="authMessage" class="message-area" style="min-height: 20px; margin-top: 1.5rem;"></div>

    </div>
  </div>

  <!-- DASHBOARD PAGE -->
  <div id="dashboardPage" class="dashboard-page">
    <div id="notificationBanner" class="notification-banner">
      üîî Enable notifications to get real-time updates!
      <button onclick="enableNotifications()">Enable Notifications</button>
    </div>

    <header>
      <h2>üéì UniVoice</h2>
      <div class="user-info">
        <span class="user-email" id="userEmail"></span>
        <button onclick="logout()">Logout</button>
      </div>
    </header>

    <div class="container">

      <!-- STUDENT PANEL -->
      <div id="studentPanel" class="hidden">

        <div class="card">
          <h3>üìù Submit Feedback</h3>
          <div class="form-group">
            <label>Category</label>
            <select id="feedbackCategory">
              <option value="Safety">üõ°Ô∏è Safety & Security</option>
              <option value="Academic">üìö Academic</option>
              <option value="Hostel">üè† Hostel</option>
              <option value="Faculty">üë®‚Äçüè´ Faculty</option>
              <option value="Infrastructure">üèóÔ∏è Infrastructure</option>
              <option value="Library">üìñ Library</option>
              <option value="Canteen">üçΩÔ∏è Canteen/Food</option>
              <option value="Transport">üöå Transport</option>
              <option value="Sports">‚öΩ Sports & Recreation</option>
              <option value="Placement">üíº Placement & Training</option>
              <option value="Other">üìã Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Location</label>
            <select id="feedbackLocation">
              <option value="Academic Block A">Academic Block A</option>
              <option value="Academic Block B">Academic Block B</option>
              <option value="Academic Block C">Academic Block C</option>
              <option value="Boys Hostel 1">Boys Hostel 1</option>
              <option value="Boys Hostel 2">Boys Hostel 2</option>
              <option value="Girls Hostel 1">Girls Hostel 1</option>
              <option value="Girls Hostel 2">Girls Hostel 2</option>
              <option value="Central Library">Central Library</option>
              <option value="Main Canteen">Main Canteen</option>
              <option value="Food Court">Food Court</option>
              <option value="Sports Complex">Sports Complex</option>
              <option value="Auditorium">Auditorium</option>
              <option value="Admin Block">Admin Block</option>
              <option value="Parking Area">Parking Area</option>
              <option value="Campus Gate">Campus Gate</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Describe your issue</label>
            <textarea id="feedbackText" placeholder="Explain the issue in detail..."></textarea>
          </div>
          <div class="form-group">
            <label>Google Drive Image URL (Optional)</label>
            <input type="url" id="feedbackImageUrl" placeholder="https://drive.google.com/file/d/xxxxx/view" />
            <p class="info-text">Share your Google Drive image link here. Make sure it's set to "Anyone with the link
              can view"</p>
          </div>
          <label class="checkbox-label">
            <input type="checkbox" id="anonymousCheckbox">
            <span>üïµÔ∏è Submit Anonymously (your identity will be hidden)</span>
          </label>
          <button onclick="submitFeedback()" class="submit-btn">Submit Feedback</button>
        </div>

        <div class="card">
          <h3>üîç Search & Filter</h3>
          <div class="search-bar">
            <input type="text" id="searchInput" class="search-input" placeholder="Search feedback..."
              onkeyup="loadStudent()">
          </div>
          <div class="filter-bar">
            <select id="filterCategory" onchange="loadStudent()">
              <option value="all">All Categories</option>
              <option value="Safety">üõ°Ô∏è Safety</option>
              <option value="Academic">üìö Academic</option>
              <option value="Hostel">üè† Hostel</option>
              <option value="Faculty">üë®‚Äçüè´ Faculty</option>
              <option value="Infrastructure">üèóÔ∏è Infrastructure</option>
              <option value="Library">üìñ Library</option>
              <option value="Canteen">üçΩÔ∏è Canteen</option>
              <option value="Transport">üöå Transport</option>
              <option value="Sports">‚öΩ Sports</option>
              <option value="Placement">üíº Placement</option>
              <option value="Other">üìã Other</option>
            </select>
            <select id="filterStatus" onchange="loadStudent()">
              <option value="all">All Status</option>
              <option value="Not Resolved">Not Resolved</option>
              <option value="In Progress">In Progress</option>
              <option value="Resolved">Resolved</option>
            </select>
            <select id="filterLocation" onchange="loadStudent()">
              <option value="all">All Locations</option>
              <option value="Academic Block A">Academic Block A</option>
              <option value="Academic Block B">Academic Block B</option>
              <option value="Boys Hostel 1">Boys Hostel 1</option>
              <option value="Girls Hostel 1">Girls Hostel 1</option>
              <option value="Central Library">Central Library</option>
              <option value="Main Canteen">Main Canteen</option>
              <option value="Sports Complex">Sports Complex</option>
            </select>
          </div>
        </div>

        <div id="feedbackList"></div>
      </div>

      <!-- ADMIN PANEL -->
      <div id="adminPanel" class="hidden">

        <div class="analytics-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalFeedback">0</div>
            <div class="stat-label">Total Feedback</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-number" id="overdueCount">0</div>
            <div class="stat-label">‚ö†Ô∏è Overdue (SLA)</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="pendingCount">0</div>
            <div class="stat-label">Pending</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="progressCount">0</div>
            <div class="stat-label">In Progress</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="resolvedCount">0</div>
            <div class="stat-label">Resolved</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avgResolutionTime">-</div>
            <div class="stat-label">Avg Resolution Time</div>
          </div>
        </div>

        <div class="chart-row">
          <div class="card">
            <h3>üìä Category Distribution</h3>
            <div class="chart-container">
              <canvas id="categoryChart"></canvas>
            </div>
          </div>

          <div class="card">
            <h3>üìà Status Overview</h3>
            <div class="chart-container">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>

        <div class="chart-row">
          <div class="card">
            <h3>üìç Issues by Location</h3>
            <div class="chart-container">
              <canvas id="locationChart"></canvas>
            </div>
          </div>

          <div class="card">
            <h3>‚è±Ô∏è Resolution Time by Category</h3>
            <div class="chart-container">
              <canvas id="resolutionTimeChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>üîù Top 5 Most Upvoted Issues</h3>
          <div class="chart-container">
            <canvas id="upvotesChart"></canvas>
          </div>
        </div>

        <div class="card">
          <h3>üéØ Manage Feedback</h3>
          <div class="search-bar">
            <input type="text" id="adminSearchInput" class="search-input" placeholder="Search feedback..."
              onkeyup="loadAdmin()">
          </div>
          <div class="filter-bar">
            <select id="adminFilterCategory" onchange="loadAdmin()">
              <option value="all">All Categories</option>
              <option value="Safety">üõ°Ô∏è Safety</option>
              <option value="Academic">üìö Academic</option>
              <option value="Hostel">üè† Hostel</option>
              <option value="Faculty">üë®‚Äçüè´ Faculty</option>
              <option value="Infrastructure">üèóÔ∏è Infrastructure</option>
              <option value="Library">üìñ Library</option>
              <option value="Canteen">üçΩÔ∏è Canteen</option>
              <option value="Transport">üöå Transport</option>
              <option value="Sports">‚öΩ Sports</option>
              <option value="Placement">üíº Placement</option>
              <option value="Other">üìã Other</option>
            </select>
            <select id="adminFilterStatus" onchange="loadAdmin()">
              <option value="all">All Status</option>
              <option value="Not Resolved">Not Resolved</option>
              <option value="In Progress">In Progress</option>
              <option value="Resolved">Resolved</option>
            </select>
            <select id="adminFilterLocation" onchange="loadAdmin()">
              <option value="all">All Locations</option>
              <option value="Academic Block A">Academic Block A</option>
              <option value="Boys Hostel 1">Boys Hostel 1</option>
              <option value="Girls Hostel 1">Girls Hostel 1</option>
              <option value="Central Library">Central Library</option>
            </select>
          </div>
          <div id="adminFeedbackList"></div>
        </div>

      </div>

    </div>
  </div>

  <script>
    // Firebase Config
    firebase.initializeApp({
      apiKey: "",
      authDomain: "univoice-hackathon.firebaseapp.com",
      projectId: "univoice-hackathon",
      storageBucket: "univoice-hackathon.firebasestorage.app",
      messagingSenderId: "937574240690",
      appId: "1:937574240690:web:7b826a9c3177bc6732d4ab"
    });

    const auth = firebase.auth();
    const db = firebase.firestore();

    // Initialize EmailJS
    const EMAILJS_SERVICE_ID = "service_3kg8vyj";
    const EMAILJS_TEMPLATE_ID = "template_hk2v46f";
    const EMAILJS_PUBLIC_KEY = "NGHVZ2yRf3v8VHVae";

    emailjs.init(EMAILJS_PUBLIC_KEY);

    const ADMINS = ["pragati.keshari_cs25@gla.ac.in"];

    // ... (SLA Thresholds)

    // Helper to send email
    function sendEmail(toEmail, subject, message, toName = "User") {
      if (EMAILJS_PUBLIC_KEY === "YOUR_PUBLIC_KEY") {
        console.warn("EmailJS keys not set. Skipping email.");
        return;
      }

      emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
        to_email: toEmail,
        to_name: toName,
        subject: subject,
        message: message
      }).then(() => {
        console.log(`Email sent to ${toEmail}`);
      }).catch((err) => {
        console.error("Failed to send email:", err);
      });
    }

    // Profanity filter with variations
    const INAPPROPRIATE_WORDS = [
      'fuck', 'f*ck', 'fck', 'fuk', 'f.u.c.k', 'f_uck', 'fu—Åk',
      'shit', 'sh*t', 'sht', 'sh!t', 's.h.i.t', 's_hit',
      'bitch', 'b*tch', 'btch', 'b!tch', 'b.i.t.c.h',
      'bastard', 'b*stard', 'bstrd', 'b@stard',
      'ass', '@ss', 'a$', 'a.s.s',
      'damn', 'd@mn', 'd*mn',
      'hell', 'h*ll', 'h3ll',
      'crap', 'cr@p', 'cr*p',
      'dick', 'd*ck', 'd!ck',
      'piss', 'p*ss', 'p!ss'
    ];

    // SLA Thresholds (in hours)
    const SLA_THRESHOLDS = {
      "Safety": 24,
      "Academic": 48,
      "Hostel": 72,
      "Faculty": 48,
      "Infrastructure": 168,
      "Library": 72,
      "Canteen": 48,
      "Transport": 72,
      "Sports": 120,
      "Placement": 120,
      "Other": 96
    };

    let categoryChartInstance = null;
    let statusChartInstance = null;
    let upvotesChartInstance = null;
    let locationChartInstance = null;
    let resolutionTimeChartInstance = null;

    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission();
    }

    function containsInappropriateContent(text) {
      const lowerText = text.toLowerCase().replace(/\s+/g, '');

      for (let word of INAPPROPRIATE_WORDS) {
        const pattern = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').replace(/[aeiou]/g, '[aeiou@*!0]');
        const regex = new RegExp(pattern, 'i');
        if (regex.test(lowerText)) {
          return true;
        }
      }

      return false;
    }

    async function blockUser(userId, email) {
      try {
        await db.collection('blockedUsers').doc(userId).set({
          email: email,
          blockedAt: firebase.firestore.FieldValue.serverTimestamp(),
          reason: 'Inappropriate content'
        });
        alert('‚õî You have been blocked for using inappropriate language. Contact admin for assistance.');
        auth.signOut();
      } catch (error) {
        console.error('Error blocking user:', error);
      }
    }

    async function isUserBlocked(userId) {
      try {
        const doc = await db.collection('blockedUsers').doc(userId).get();
        return doc.exists;
      } catch (error) {
        console.error('Error checking block status:', error);
        return false;
      }
    }

    function showNotification(title, body) {
      if ("Notification" in window && Notification.permission === "granted") {
        new Notification(title, { body, icon: "üéì" });
      }
    }

    function enableNotifications() {
      if ("Notification" in window) {
        Notification.requestPermission().then(permission => {
          if (permission === "granted") {
            document.getElementById('notificationBanner').classList.remove('show');
            showNotification("üéâ Notifications Enabled!", "You'll receive real-time updates");
          }
        });
      }
    }

    function checkNotificationPermission() {
      if ("Notification" in window && Notification.permission !== "granted") {
        document.getElementById('notificationBanner').classList.add('show');
      }
    }

    function calculateSLA(createdAt, category, status) {
      if (status === "Resolved") return { class: "sla-green", text: "‚úÖ Resolved" };
      if (!createdAt) return { class: "sla-yellow", text: "‚è≥ Processing" };

      const created = createdAt.toDate();
      const now = new Date();
      const hoursElapsed = (now - created) / (1000 * 60 * 60);
      const threshold = SLA_THRESHOLDS[category] || 96;
      const hoursRemaining = threshold - hoursElapsed;

      if (hoursRemaining < 0) {
        return { class: "sla-red", text: `üî¥ ${Math.abs(hoursRemaining).toFixed(0)}h overdue` };
      } else if (hoursRemaining < threshold * 0.25) {
        return { class: "sla-yellow", text: `üü° ${hoursRemaining.toFixed(0)}h left` };
      } else {
        return { class: "sla-green", text: `üü¢ ${hoursRemaining.toFixed(0)}h left` };
      }
    }

    function convertGoogleDriveUrl(url) {
      if (!url) return null;
      // Convert Google Drive sharing link to direct view link
      const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if (fileIdMatch) {
        return `https://drive.google.com/uc?export=view&id=${fileIdMatch[1]}`;
      }
      return url;
    }

    // --- AUTH FUNCTIONS ---
    let isSignupFlow = false;

    // Toggle between Login and Signup tabs
    function switchAuthMode(mode) {
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const tabLogin = document.getElementById('tab-login');
      const tabSignup = document.getElementById('tab-signup');
      const messageBox = document.getElementById('authMessage');

      // Clear messages when switching
      messageBox.innerHTML = '';

      if (mode === 'login') {
        loginForm.style.display = 'block';
        signupForm.style.display = 'none';
        tabLogin.classList.add('active');
        tabSignup.classList.remove('active');
      } else {
        loginForm.style.display = 'none';
        signupForm.style.display = 'block';
        tabLogin.classList.remove('active');
        tabSignup.classList.add('active');
      }
    }

    // SIGN UP / SET PASSWORD
    function handleSignup() {
      isSignupFlow = true;
      const emailInput = document.getElementById('signupEmail');
      const messageBox = document.getElementById('authMessage');
      const emailValue = emailInput.value.trim();

      if (!emailValue) {
        messageBox.innerHTML = '<div class="error-message">Please enter your college email address.</div>';
        return;
      }
      if (!emailValue.endsWith("@gla.ac.in")) {
        messageBox.innerHTML = '<div class="error-message">‚ö†Ô∏è Only @gla.ac.in emails are allowed.</div>';
        return;
      }

      messageBox.innerHTML = '<div class="success-message">Status: Verifying account details...</div>';

      // STRATEGY: Try to CREATE (if new) -> Then RESET PASSWORD
      const tempPassword = Math.random().toString(36).slice(-8) + "Aa1!";

      auth.createUserWithEmailAndPassword(emailValue, tempPassword)
        .then(() => {
          // SUCCESS: New Account Created
          messageBox.innerHTML = '<div class="success-message">Step 1: Account Created! Sending setup link...</div>';
          // Send Reset Link
          return auth.sendPasswordResetEmail(emailValue);
        })
        .then(() => {
          // Force logout (so they set their real password)
          auth.signOut().then(() => {
            isSignupFlow = false;
          });
          messageBox.innerHTML = '<div class="success-message">‚úÖ Account Created! Check your email inbox and spam folder to set your password.</div>';
        })
        .catch(error => {
          if (error.code === 'auth/email-already-in-use') {
            // Account EXISTS: Just send reset link
            messageBox.innerHTML = '<div class="success-message">Account exists. Sending setup link...</div>';
            auth.sendPasswordResetEmail(emailValue)
              .then(() => {
                messageBox.innerHTML = '<div class="success-message">‚úÖ Link Sent! Check your inbox and spam folder to reset your password.</div>';
              })
              .catch(resetErr => {
                messageBox.innerHTML = `<div class="error-message">Error: ${resetErr.message}</div>`;
              });
          } else {
            messageBox.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
          }
          isSignupFlow = false;
        });
    }

    // LOGIN
    function handleLogin() {
      const emailInput = document.getElementById('loginEmail');
      const passwordInput = document.getElementById('loginPassword');
      const messageBox = document.getElementById('authMessage');
      const emailValue = emailInput.value.trim();
      const passwordValue = passwordInput.value;

      if (!emailValue || !passwordValue) {
        messageBox.innerHTML = '<div class="error-message">Please enter both email and password.</div>';
        return;
      }

      messageBox.innerHTML = '';

      auth.signInWithEmailAndPassword(emailValue, passwordValue)
        .catch(error => {
          if (error.code === 'auth/user-not-found') {
            messageBox.innerHTML = '<div class="error-message">Account not found. Please switch to the <b>New Student</b> tab to sign up.</div>';
          } else if (error.code === 'auth/wrong-password') {
            messageBox.innerHTML = '<div class="error-message">Incorrect password. <a onclick="forgotPassword()" style="cursor:pointer;text-decoration:underline;">Forgot Password?</a></div>';
          } else {
            messageBox.innerHTML = `<div class="error-message">${error.message}</div>`;
          }
        });
    }

    // FORGOT PASSWORD
    function forgotPassword() {
      const email = document.getElementById('loginEmail').value.trim();
      const messageBox = document.getElementById('authMessage');

      if (!email) {
        messageBox.innerHTML = '<div class="error-message">Please enter your email in the box above first.</div>';
        return;
      }

      auth.sendPasswordResetEmail(email)
        .then(() => {
          messageBox.innerHTML = '<div class="success-message">‚úÖ Reset link sent! Check your email inbox and spam folder.</div>';
        })
        .catch(err => {
          messageBox.innerHTML = `<div class="error-message">${err.message}</div>`;
        });
    }


    auth.onAuthStateChanged(async user => {
      const loginPage = document.getElementById('loginPage');
      const dashboardPage = document.getElementById('dashboardPage');
      const studentPanel = document.getElementById('studentPanel');
      const adminPanel = document.getElementById('adminPanel');
      const userEmail = document.getElementById('userEmail');

      if (!user) {
        loginPage.style.display = 'flex';
        dashboardPage.classList.remove('active');
        return;
      }

      // Check if user is blocked
      const blocked = await isUserBlocked(user.uid);
      if (blocked) {
        alert('‚õî Your account has been blocked for violating community guidelines.');
        auth.signOut();
        return;
      }

      // Prevent flash if we are in the middle of a signup flow
      if (isSignupFlow) return;

      loginPage.style.display = 'none';
      dashboardPage.classList.add('active');
      userEmail.textContent = user.email;

      const isAdmin = ADMINS.includes(user.email);
      (isAdmin ? adminPanel : studentPanel).classList.remove("hidden");
      isAdmin ? loadAdmin() : loadStudent();
      setTimeout(checkNotificationPermission, 1000);
    });

    function logout() {
      auth.signOut();
      location.reload();
    }

    function submitFeedback() {
      const text = document.getElementById('feedbackText').value.trim();
      const category = document.getElementById('feedbackCategory').value;
      const location = document.getElementById('feedbackLocation').value;
      const imageUrl = document.getElementById('feedbackImageUrl').value.trim();
      const isAnonymous = document.getElementById('anonymousCheckbox').checked;

      if (!text) {
        alert("Please write your feedback");
        return;
      }

      // Check for inappropriate content
      if (containsInappropriateContent(text)) {
        alert('‚õî Your feedback contains inappropriate language and cannot be submitted. Your account will be blocked.');
        blockUser(auth.currentUser.uid, auth.currentUser.email);
        return;
      }

      const convertedImageUrl = convertGoogleDriveUrl(imageUrl);

      db.collection("feedback").add({
        text,
        category,
        location,
        status: "Not Resolved",
        upvotes: 0,
        upvotedBy: [],
        imageUrl: convertedImageUrl,
        isAnonymous,
        createdBy: isAnonymous ? null : auth.currentUser.uid,
        createdByEmail: isAnonymous ? "Anonymous" : auth.currentUser.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        document.getElementById('feedbackText').value = "";
        document.getElementById('feedbackImageUrl').value = "";
        document.getElementById('anonymousCheckbox').checked = false;
        alert("Feedback submitted successfully!");
        showNotification("üéì Feedback Submitted", `Category: ${category}`);

        // Email to Admin
        sendEmail(ADMINS[0], "New Feedback Received", `New feedback in ${category} at ${location}: ${text}`, "Admin");

        // Email to Student (if not anonymous)
        if (!isAnonymous && auth.currentUser.email) {
          sendEmail(auth.currentUser.email, "Feedback Received", `We received your feedback regarding ${category}. We will look into it.`, "Student");
        }
      });
    }

    function loadStudent() {
      const feedbackList = document.getElementById('feedbackList');
      const filterCategory = document.getElementById('filterCategory').value;
      const filterStatus = document.getElementById('filterStatus').value;
      const filterLocation = document.getElementById('filterLocation').value;
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();

      db.collection("feedback").orderBy("upvotes", "desc").onSnapshot(snap => {
        feedbackList.innerHTML = "";

        snap.docChanges().forEach(change => {
          if (change.type === "modified") {
            const f = change.doc.data();
            if (!f.isAnonymous && f.createdBy === auth.currentUser.uid) {
              showNotification("üì¢ Status Updated", `Your feedback: ${f.status}`);
            }
          }
        });

        snap.forEach(doc => {
          const f = doc.data();

          if (filterCategory !== "all" && f.category !== filterCategory) return;
          if (filterStatus !== "all" && f.status !== filterStatus) return;
          if (filterLocation !== "all" && f.location !== filterLocation) return;
          if (searchQuery && !f.text.toLowerCase().includes(searchQuery)) return;

          const statusClass = f.status === "Resolved" ? "status-resolved" :
            f.status === "In Progress" ? "status-in-progress" : "status-not-resolved";
          const categoryClass = `category-${f.category.toLowerCase()}`;
          const sla = calculateSLA(f.createdAt, f.category, f.status);
          const imageHtml = f.imageUrl ?
            `<a href="${f.imageUrl}" target="_blank" class="image-link">üì∑ View Attached Image</a>` : '';
          const anonymousBadge = f.isAnonymous ? '<span class="badge anonymous-badge">üïµÔ∏è Anonymous</span>' : '';

          feedbackList.innerHTML += `
          <div class="feedback-item" id="feedback-${doc.id}">
            <div class="feedback-text">${f.text}</div>
            ${imageHtml}
            <div class="feedback-meta">
              <span class="badge ${statusClass}">${f.status}</span>
              <span class="badge ${categoryClass}">${f.category}</span>
              <span class="badge" style="background: #e2e8f0; color: #4a5568;">üìç ${f.location}</span>
              ${anonymousBadge}
              <span class="badge ${sla.class} sla-timer">${sla.text}</span>
            </div>
            <button class="upvote-btn" onclick="upvote('${doc.id}')">
              üëç Upvote (${f.upvotes})
            </button>
            <button class="toggle-comments-btn" onclick="toggleComments('${doc.id}')">
              üí¨ Comments
            </button>
            <div id="comments-${doc.id}" class="comments-section hidden"></div>
          </div>`;

          loadComments(doc.id);
        });
      });
    }

    function toggleComments(feedbackId) {
      const commentsSection = document.getElementById(`comments-${feedbackId}`);
      commentsSection.classList.toggle('hidden');

      if (!commentsSection.classList.contains('hidden') && !commentsSection.dataset.loaded) {
        commentsSection.innerHTML = `
          <div id="comments-list-${feedbackId}"></div>
          <div class="comment-form">
            <input type="text" id="comment-input-${feedbackId}" class="comment-input" placeholder="Add a comment...">
            <button class="comment-btn" onclick="addComment('${feedbackId}')">Post</button>
          </div>
        `;
        commentsSection.dataset.loaded = 'true';
      }
    }

    function loadComments(feedbackId) {
      db.collection("feedback").doc(feedbackId).collection("comments")
        .orderBy("createdAt", "asc")
        .onSnapshot(snap => {
          const commentsList = document.getElementById(`comments-list-${feedbackId}`);
          if (!commentsList) return;
          commentsList.innerHTML = "";
          snap.forEach(doc => {
            const c = doc.data();
            commentsList.innerHTML += `
              <div class="comment">
                <div class="comment-author">${c.authorEmail}</div>
                <div class="comment-text">${c.text}</div>
              </div>
            `;
          });
        });
    }

    function addComment(feedbackId) {
      const input = document.getElementById(`comment-input-${feedbackId}`);
      const text = input.value.trim();
      if (!text) return;

      db.collection("feedback").doc(feedbackId).collection("comments").add({
        text,
        authorEmail: auth.currentUser.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        input.value = "";
        showNotification("üí¨ Comment Added", "Your comment was posted");
      });
    }

    function upvote(id) {
      const ref = db.collection("feedback").doc(id);
      ref.get().then(d => {
        if (d.data().upvotedBy.includes(auth.currentUser.uid)) {
          alert("You've already upvoted this!");
          return;
        }
        ref.update({
          upvotes: firebase.firestore.FieldValue.increment(1),
          upvotedBy: firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid)
        });
      });
    }

    function loadAdmin() {
      const adminFeedbackList = document.getElementById('adminFeedbackList');
      const filterCategory = document.getElementById('adminFilterCategory').value;
      const filterStatus = document.getElementById('adminFilterStatus').value;
      const filterLocation = document.getElementById('adminFilterLocation').value;
      const searchQuery = document.getElementById('adminSearchInput').value.toLowerCase();

      db.collection("feedback").onSnapshot(snap => {
        adminFeedbackList.innerHTML = "";
        let stats = {
          categories: {},
          statuses: { "Not Resolved": 0, "In Progress": 0, "Resolved": 0 },
          locations: {},
          total: 0,
          overdue: 0,
          topUpvoted: [],
          resolutionTimes: {}
        };

        const feedbackArray = [];

        snap.forEach(doc => {
          const f = doc.data();
          stats.total++;
          stats.categories[f.category] = (stats.categories[f.category] || 0) + 1;
          stats.statuses[f.status]++;
          stats.locations[f.location] = (stats.locations[f.location] || 0) + 1;

          const sla = calculateSLA(f.createdAt, f.category, f.status);
          if (sla.class === "sla-red") stats.overdue++;

          if (f.status === "Resolved" && f.createdAt && f.resolvedAt) {
            const resTime = (f.resolvedAt.toDate() - f.createdAt.toDate()) / (1000 * 60 * 60);
            if (!stats.resolutionTimes[f.category]) stats.resolutionTimes[f.category] = [];
            stats.resolutionTimes[f.category].push(resTime);
          }

          feedbackArray.push({ id: doc.id, ...f });
        });

        feedbackArray.sort((a, b) => b.upvotes - a.upvotes);
        stats.topUpvoted = feedbackArray.slice(0, 5);

        feedbackArray.forEach(f => {
          if (filterCategory !== "all" && f.category !== filterCategory) return;
          if (filterStatus !== "all" && f.status !== filterStatus) return;
          if (filterLocation !== "all" && f.location !== filterLocation) return;
          if (searchQuery && !f.text.toLowerCase().includes(searchQuery)) return;

          const statusClass = f.status === "Resolved" ? "status-resolved" :
            f.status === "In Progress" ? "status-in-progress" : "status-not-resolved";
          const categoryClass = `category-${f.category.toLowerCase()}`;
          const sla = calculateSLA(f.createdAt, f.category, f.status);
          const imageHtml = f.imageUrl ?
            `<a href="${f.imageUrl}" target="_blank" class="image-link">üì∑ View Attached Image</a>` : '';
          const anonymousBadge = f.isAnonymous ? '<span class="badge anonymous-badge">üïµÔ∏è Anonymous</span>' : '';

          adminFeedbackList.innerHTML += `
          <div class="feedback-item" id="admin-feedback-${f.id}">
            <div class="feedback-text">${f.text}</div>
            ${imageHtml}
            <div class="feedback-meta">
              <span class="badge ${categoryClass}">${f.category}</span>
              <span class="badge" style="background: #e2e8f0; color: #4a5568;">üìç ${f.location}</span>
              ${anonymousBadge}
              <span class="badge ${sla.class} sla-timer">${sla.text}</span>
              <span>üëç ${f.upvotes} upvotes</span>
            </div>
            <select onchange="updateStatus('${f.id}', this.value)">
              <option ${f.status === "Not Resolved" ? "selected" : ""}>Not Resolved</option>
              <option ${f.status === "In Progress" ? "selected" : ""}>In Progress</option>
              <option ${f.status === "Resolved" ? "selected" : ""}>Resolved</option>
            </select>
            <button class="toggle-comments-btn" onclick="toggleAdminComments('${f.id}')" style="background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); padding: 6px 12px; font-size: 12px; margin-left: 8px; border:none; color:white; border-radius:4px; cursor:pointer;">
              üí¨ Comments
            </button>
            <div id="admin-comments-${f.id}" class="comments-section hidden" style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;"></div>
          </div>`;

          loadAdminComments(f.id);
        });

        updateStats(stats);
        drawCharts(stats);
      });
    }

    function toggleAdminComments(feedbackId) {
      const commentsSection = document.getElementById(`admin-comments-${feedbackId}`);
      commentsSection.classList.toggle('hidden');

      if (!commentsSection.classList.contains('hidden') && !commentsSection.dataset.loaded) {
        commentsSection.innerHTML = `
          <div id="admin-comments-list-${feedbackId}"></div>
            <button class="comment-btn" onclick="addAdminComment('${feedbackId}')">Post</button>
          </div>
        `;
        commentsSection.dataset.loaded = 'true';
      }
    }

    function loadAdminComments(feedbackId) {
      db.collection("feedback").doc(feedbackId).collection("comments")
        .orderBy("createdAt", "asc")
        .onSnapshot(snap => {
          const commentsList = document.getElementById(`admin-comments-list-${feedbackId}`);
          if (!commentsList) return;
          commentsList.innerHTML = "";
          snap.forEach(doc => {
            const c = doc.data();
            commentsList.innerHTML += `
              <div class="comment">
                <div class="comment-author">${c.authorEmail}</div>
                <div class="comment-text">${c.text}</div>
              </div>
            `;
          });
        });
    }

    function addAdminComment(feedbackId) {
      const input = document.getElementById(`admin-comment-input-${feedbackId}`);
      const text = input.value.trim();
      if (!text) return;

      db.collection("feedback").doc(feedbackId).collection("comments").add({
        text,
        authorEmail: auth.currentUser.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => input.value = "");
    }

    function updateStats(stats) {
      document.getElementById('totalFeedback').textContent = stats.total;
      document.getElementById('overdueCount').textContent = stats.overdue;
      document.getElementById('pendingCount').textContent = stats.statuses["Not Resolved"];
      document.getElementById('progressCount').textContent = stats.statuses["In Progress"];
      document.getElementById('resolvedCount').textContent = stats.statuses["Resolved"];

      let totalResTime = 0;
      let count = 0;
      Object.values(stats.resolutionTimes).forEach(times => {
        times.forEach(t => { totalResTime += t; count++; });
      });
      const avgHours = count > 0 ? (totalResTime / count).toFixed(1) : 0;
      document.getElementById('avgResolutionTime').textContent = avgHours > 0 ? `${avgHours}h` : "-";
    }

    function updateStatus(id, status) {
      const update = { status };
      if (status === "Resolved") {
        update.resolvedAt = firebase.firestore.FieldValue.serverTimestamp();
      }

      db.collection("feedback").doc(id).update(update).then(() => {
        showNotification("‚úÖ Status Updated", `Marked as: ${status}`);

        // Email to Student (we need to fetch the feedback to get the creator's email)
        db.collection("feedback").doc(id).get().then(doc => {
          const data = doc.data();
          if (data && !data.isAnonymous && data.createdByEmail) {
            sendEmail(data.createdByEmail, `Update: ${status}`, `Your feedback regarding ${data.category} is now marked as: ${status}.`, "Student");
          }
        });

        if (status === "Resolved") {
          alert("‚úÖ Issue marked as resolved!");
        }
      });
    }

    function drawCharts(stats) {
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      if (categoryChartInstance) categoryChartInstance.destroy();
      categoryChartInstance = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(stats.categories),
          datasets: [{
            data: Object.values(stats.categories),
            backgroundColor: ['#fbbf24', '#a78bfa', '#34d399', '#60a5fa', '#f472b6', '#fb923c', '#14b8a6', '#c084fc', '#4ade80', '#ef4444', '#94a3b8']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });

      const statusCtx = document.getElementById('statusChart').getContext('2d');
      if (statusChartInstance) statusChartInstance.destroy();
      statusChartInstance = new Chart(statusCtx, {
        type: 'bar',
        data: {
          labels: ['Not Resolved', 'In Progress', 'Resolved'],
          datasets: [{
            label: 'Count',
            data: [stats.statuses["Not Resolved"], stats.statuses["In Progress"], stats.statuses["Resolved"]],
            backgroundColor: ['#f87171', '#60a5fa', '#34d399'],
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      const locationCtx = document.getElementById('locationChart').getContext('2d');
      if (locationChartInstance) locationChartInstance.destroy();
      locationChartInstance = new Chart(locationCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(stats.locations),
          datasets: [{
            label: 'Issues',
            data: Object.values(stats.locations),
            backgroundColor: '#8b5cf6',
            borderRadius: 8
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { beginAtZero: true } }
        }
      });

      const resTimeCtx = document.getElementById('resolutionTimeChart').getContext('2d');
      if (resolutionTimeChartInstance) resolutionTimeChartInstance.destroy();
      const resTimeData = {};
      Object.keys(stats.resolutionTimes).forEach(cat => {
        const times = stats.resolutionTimes[cat];
        resTimeData[cat] = times.length > 0 ? (times.reduce((a, b) => a + b, 0) / times.length) : 0;
      });
      resolutionTimeChartInstance = new Chart(resTimeCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(resTimeData),
          datasets: [{
            label: 'Avg Hours',
            data: Object.values(resTimeData),
            backgroundColor: '#10b981',
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      const upvotesCtx = document.getElementById('upvotesChart').getContext('2d');
      if (upvotesChartInstance) upvotesChartInstance.destroy();
      upvotesChartInstance = new Chart(upvotesCtx, {
        type: 'bar',
        data: {
          labels: stats.topUpvoted.map((f, i) => `Issue #${i + 1}`),
          datasets: [{
            label: 'Upvotes',
            data: stats.topUpvoted.map(f => f.upvotes),
            backgroundColor: '#8b5cf6',
            borderRadius: 8
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { beginAtZero: true } }
        }
      });
    }
  </script>

</body>

</html>
